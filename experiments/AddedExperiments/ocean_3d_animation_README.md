# 三维海气立方体动态可视化使用说明

## 概述

`ocean_3d_animation.py` 实现了基于 `velocity_3D_vector_optimized.py` 的三维海气立方体动态可视化，展示10小时（每帧1小时）的标量场和矢量场变化。

## 功能特性

### ✅ 已实现功能

1. **时间序列数据加载**
   - 支持加载多个时间步的数据（默认10个时间步，每步1小时）
   - 参考 `detect14month2.py` 的时间数据读取方法
   - 自动处理数据加载失败的情况

2. **标量场动态更新**
   - 温度（颜色）随时间平滑变化
   - 盐度（透明度）随时间平滑变化
   - 使用线性插值实现帧间平滑过渡

3. **动画控制器**
   - 播放/暂停控制
   - 帧切换（上一帧/下一帧）
   - 自动更新机制（定时器回调）

4. **基础矢量场动画框架**
   - 静止帧亮度传递函数（已定义，待完善应用）
   - 播放帧渐显渐隐函数（已定义，待完善应用）

### ⚠️ 待完善功能

1. **矢量场动画效果**
   - 静止帧：箭头亮度沿流速方向传递（函数已定义，需要完善应用到箭头mesh）
   - 播放帧：箭头从尾到头渐显渐隐（函数已定义，需要完善应用到箭头mesh）
   - 当前实现为简化版本，使用平均透明度/亮度

2. **箭头参数化**
   - 需要完善箭头点的参数化计算（沿流速方向的精确位置）
   - 当前使用简化方法（中点位置）

3. **性能优化**
   - 体积渲染的动态更新可能需要优化
   - 箭头mesh的更新逻辑需要改进（避免频繁重建）

## 使用方法

### 运行程序

```bash
python ocean_3d_animation.py
```

### 控制说明

- **空格键**：播放/暂停动画
- **右箭头键**：切换到下一帧
- **左箭头键**：切换到上一帧

### 动画模式

1. **播放模式**（按空格键开始播放）
   - 自动按时间顺序播放各帧
   - 每帧持续1秒（可调整fps参数）
   - 标量场平滑过渡

2. **静止模式**（暂停时）
   - 显示当前帧的数据
   - 可以手动切换帧查看不同时间步
   - 计划实现箭头亮度传递效果（待完善）

## 代码结构

```
ocean_3d_animation.py
├── 数据加载模块
│   ├── load_dataset()              # 加载数据集
│   ├── read_data_at_time()         # 读取指定时间步的数据
│   └── load_time_series_data()     # 加载时间序列数据
├── 动画控制模块
│   └── AnimationController          # 动画控制器类
├── 标量场动画模块
│   └── interpolate_scalar_field()  # 标量场时间插值
├── 矢量场动画模块
│   ├── parameterize_arrow_points() # 箭头参数化（待完善）
│   ├── compute_flow_brightness()   # 静止帧亮度函数
│   └── compute_temporal_alpha()    # 播放帧透明度函数
└── 主程序
    ├── 场景初始化
    ├── 动画更新回调
    └── 交互控制
```

## 参数配置

在代码开头可以调整以下参数：

```python
# 时间范围
TIME_START = 0      # 起始时间步
TIME_END = 9        # 结束时间步（共10个时间步）

# 区域范围
lat_start, lat_end = 10, 40
lon_start, lon_end = 100, 130

# 数据质量
data_quality = -6   # 降低分辨率以提升性能

# 动画参数
fps = 1.0           # 帧率（帧/秒）
cycle_speed = 0.5   # 静止帧周期动画速度
```

## 技术细节

### 时间插值

使用线性插值实现标量场在时间维度上的平滑过渡：

```python
interpolated = (1 - t) * data[idx_low] + t * data[idx_high]
```

### 静止帧亮度函数

线性函数实现亮度沿箭头方向传递：

```python
brightness(s, t) = 1 - (s + t_cycle) % 1
```

其中：
- `s`: 沿箭头方向的归一化位置（0=尾部，1=头部）
- `t_cycle`: 周期时间（0-1）

### 播放帧透明度函数

实现箭头从尾到头的渐显渐隐：

```python
if t_frame < 0.5:
    alpha = 1 if s <= 2*t_frame else 0  # 渐显
else:
    alpha = 1 if s > 2*(t_frame-0.5) else 0  # 渐隐
```

## 已知问题

1. **箭头动画效果不完整**
   - 当前使用简化方法（平均透明度/亮度）
   - 需要完善箭头点的精确参数化和动画应用

2. **体积渲染更新可能较慢**
   - 频繁更新体积渲染数据可能影响性能
   - 建议使用LOD优化或降低更新频率

3. **内存使用**
   - 10个时间步的数据同时加载可能占用较多内存
   - 可以考虑按需加载或使用数据缓存

## 后续改进计划

1. **完善箭头动画**
   - 实现精确的箭头点参数化
   - 完善亮度/透明度的逐点应用
   - 优化箭头mesh更新逻辑

2. **性能优化**
   - 实现数据缓存机制
   - 优化体积渲染更新
   - 添加LOD支持

3. **功能增强**
   - 添加时间轴显示
   - 支持导出动画
   - 添加更多控制选项（速度调节等）

## 参考文件

- `velocity_3D_vector_optimized.py`: 基础可视化实现
- `detect14month2.py`: 时间数据读取方法
- `ocean_3d_animation_plan.md`: 详细实现计划

